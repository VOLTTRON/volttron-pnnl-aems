# Traefik Proxy Configuration

<p align="center">
  <strong>TLS certificate management and proxy configuration for Traefik</strong>
</p>

<p align="center">
  <a href="https://traefik.io/" target="_blank">
    <img src="https://img.shields.io/badge/traefik-2.10-orange.svg" alt="Traefik Version" />
  </a>
  <a href="https://letsencrypt.org/" target="_blank">
    <img src="https://img.shields.io/badge/Let's_Encrypt-supported-green.svg" alt="Let's Encrypt Support" />
  </a>
</p>

---

## Overview

This directory contains TLS certificate configuration for the Traefik reverse proxy. Traefik handles SSL/TLS termination and routing for the Skeleton App, supporting both self-signed certificates for development and Let's Encrypt certificates for production.

## Certificate Management

### Development Certificates (Self-Signed)

For development environments, certificates are automatically generated using mkcert:

- **Certificate Authority**: `mkcert-ca.crt` (generated by certs service)
- **Host Certificate**: `mkcert-hostname.crt` (generated by certs service)
- **Private Key**: `mkcert-hostname.key` (generated by certs service)

The certificates are automatically mounted into the Traefik container and configured via the `certs-traefik.yml` file.

### Production Certificates (Let's Encrypt)

For production deployments with valid domain names, Traefik can automatically obtain certificates from Let's Encrypt:

```bash
# Configure in main .env file
CERT_RESOLVER=letsencrypt
ADMIN_EMAIL=your.email@example.com
HOSTNAME=yourdomain.com
```

### Custom Certificates

To use custom TLS certificates instead of auto-generated ones:

1. **Place certificate files** in this directory:
   ```
   docker/proxy/
   ├── your-domain.crt    # Certificate file
   ├── your-domain.key    # Private key file
   └── ca-bundle.crt      # Certificate authority bundle (optional)
   ```

2. **Update configuration** in `certs-traefik.yml`:
   ```yaml
   tls:
     certificates:
       - certFile: /etc/certs/your-domain.crt
         keyFile: /etc/certs/your-domain.key
   ```

3. **Restart Traefik** service:
   ```bash
   docker compose restart proxy
   ```

## Configuration File

### certs-traefik.yml

This file configures TLS certificates for Traefik. Multiple certificate pairs can be added as needed:

```yaml
# Example configuration for multiple domains
tls:
  certificates:
    - certFile: /etc/certs/mkcert-hostname.crt
      keyFile: /etc/certs/mkcert-hostname.key
    - certFile: /etc/certs/production-domain.crt
      keyFile: /etc/certs/production-domain.key
    - certFile: /etc/certs/staging-domain.crt
      keyFile: /etc/certs/staging-domain.key
```

### Certificate Path Mapping

Certificates placed in this directory are mounted to `/etc/certs/` inside the Traefik container:

| Host Path | Container Path | Purpose |
|-----------|----------------|---------|
| `docker/proxy/mkcert-ca.crt` | `/etc/certs/mkcert-ca.crt` | Certificate Authority |
| `docker/proxy/mkcert-hostname.crt` | `/etc/certs/mkcert-hostname.crt` | Host Certificate |
| `docker/proxy/mkcert-hostname.key` | `/etc/certs/mkcert-hostname.key` | Private Key |
| `docker/proxy/custom.crt` | `/etc/certs/custom.crt` | Custom Certificate |

## Security Considerations

### Certificate Security

- **Private Keys**: Ensure private key files have restricted permissions (600)
- **Certificate Validation**: Verify certificate validity and expiration dates
- **CA Trust**: Install the mkcert CA in browsers for development
- **Rotation**: Implement certificate rotation for production environments

### Traefik Security Headers

Traefik automatically applies security headers:

- **HTTPS Redirect**: Automatic HTTP to HTTPS redirection
- **HSTS**: HTTP Strict Transport Security headers
- **Security Headers**: XSS protection, content type sniffing protection
- **Frame Options**: Clickjacking protection

## Troubleshooting

### Certificate Issues

#### Self-Signed Certificate Warnings

```bash
# Install mkcert CA in browser trust store
# The CA certificate is available at: docker/proxy/mkcert-ca.crt

# For Chrome/Edge: Import to "Trusted Root Certification Authorities"
# For Firefox: Import to "Authorities" in Certificate Manager
```

#### Let's Encrypt Certificate Failures

```bash
# Check Traefik logs
docker compose logs proxy

# Verify domain DNS resolution
nslookup yourdomain.com

# Ensure ports 80 and 443 are accessible from internet
curl -I http://yourdomain.com/.well-known/acme-challenge/test
```

#### Custom Certificate Problems

```bash
# Verify certificate validity
openssl x509 -in your-domain.crt -text -noout

# Check private key matches certificate
openssl x509 -noout -modulus -in your-domain.crt | openssl md5
openssl rsa -noout -modulus -in your-domain.key | openssl md5

# Test certificate chain
openssl verify -CAfile ca-bundle.crt your-domain.crt
```

### Common Issues

#### Certificate Not Found

```bash
# Verify file exists and has correct permissions
ls -la docker/proxy/
chmod 600 docker/proxy/*.key
chmod 644 docker/proxy/*.crt
```

#### Traefik Configuration Errors

```bash
# Validate Traefik configuration
docker compose config

# Check Traefik dashboard (if enabled)
# Access: https://localhost/dashboard/
```

#### Browser Certificate Errors

```bash
# Clear browser certificate cache
# Chrome: Settings > Privacy > Clear browsing data > Cached images and files
# Firefox: Settings > Privacy > Clear Data > Cached Web Content
```

## Certificate Renewal

### Automatic Renewal (Let's Encrypt)

Let's Encrypt certificates are automatically renewed by Traefik:

- **Renewal Period**: 30 days before expiration
- **Challenge Method**: HTTP-01 challenge
- **Storage**: Certificates stored in Docker volume

### Manual Renewal (Custom Certificates)

For custom certificates, implement a renewal process:

```bash
# Example renewal script
#!/bin/bash
# Update certificate files
cp /path/to/new/certificate.crt docker/proxy/your-domain.crt
cp /path/to/new/private.key docker/proxy/your-domain.key

# Restart Traefik to load new certificates
docker compose restart proxy
```

## Best Practices

### Development

- Use mkcert for local development certificates
- Install the mkcert CA in your browser trust store
- Use `localhost` or `127.0.0.1` as hostname for local testing

### Production

- Use Let's Encrypt for automatic certificate management
- Implement certificate monitoring and alerting
- Use strong private keys (RSA 2048+ or ECDSA P-256+)
- Regularly update Traefik to latest security patches

### Security

- Store private keys securely with restricted permissions
- Use certificate pinning for critical applications
- Implement certificate transparency monitoring
- Regular security audits of TLS configuration

---

<p align="center">
  <strong>TLS Certificate Management for Skeleton App</strong><br>
  <em>Secure HTTPS termination with Traefik</em>
</p>
